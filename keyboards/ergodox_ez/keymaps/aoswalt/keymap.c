#include QMK_KEYBOARD_H
#include "version.h"

enum alt_layers {
  _DEFAULT,
  _FN,
  _MEDIA,
};

enum custom_keycodes {
  VERSION = SAFE_RANGE,  // Send version string
  MD_BOOT,               //Restart into bootloader after hold timeout
};

#define CTL_ESC CTL_T(KC_ESC)  // tap esc - hold ctrl
#define KC_OS KC_LGUI
#define KC_____ _______
#define RGB_BRD RGB_VAD
#define RGB_BRU RGB_VAI
#define RGB_HUU RGB_HUI

#define L_MEDIA TT(_MEDIA)
#define L_FN TT(_FN)

/* LT(MDIA, KC_SCLN), */


const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/* _DEFAULT layer
 *
 *              ,--------------------------------------------------.            ,--------------------------------------------------.
 *              | Grv    |   1  |   2  |   3  |   4  |   5  |  Grv |            |   =  |   6  |   7  |   8  |   9  |   0  |   -    |
 *              |--------+------+------+------+------+-------------|            |------+------+------+------+------+------+--------|
 *              | Tab    |   Q  |   W  |   E  |   R  |   T  |   [  |            |   ]  |   Y  |   U  |   I  |   O  |   P  |   \    |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |Ctrl/Esc|   A  |   S  |   D  |   F  |   G  |------|            |------|   H  |   J  |   K  |   L  |   ;  |  '"    |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              | LShift |   Z  |   X  |   C  |   V  |   B  |      |            |      |   N  |   M  |   ,  |   .  |   /  | RShift |
 *              `--------+------+------+------+------+-------------'            `-------------+------+------+------+------+--------'
 *               |L_MEDIA|      |      |  OS  |  Alt |                                        | Left | Down |  Up  | Right|      |
 *               `-----------------------------------'                                        `----------------------------------'
 *                                                     ,-------------.        ,-------------.
 *                 Hyper                               |      |      |        |      |  Del  |
 *                 Meh                          ,------|------|------|        |------+-------+------.
 *                 AltShift                     |      |      |      |        |      |       |      |
 *                 L1                           |Backsp|  Tab |------|        |------| Enter |Space |
 *                                              |ace   |      | L_FN |        | L_FN |       |      |
 *                                              `--------------------'        `---------------------'
 */

[_DEFAULT] = LAYOUT_ergodox_pretty(
  KC_GRV,   KC_1,     KC_2,     KC_3,     KC_4,     KC_5,     KC_GRV,         KC_EQL,   KC_6,     KC_7,     KC_8,     KC_9,     KC_0,     KC_MINS,
  KC_TAB,   KC_Q,     KC_W,     KC_E,     KC_R,     KC_T,     KC_LBRC,        KC_RBRC,  KC_Y,     KC_U,     KC_I,     KC_O,     KC_P,     KC_BSLS,
  CTL_ESC,  KC_A,     KC_S,     KC_D,     KC_F,     KC_G,                               KC_H,     KC_J,     KC_K,     KC_L,     KC_SCLN,  KC_QUOT,
  KC_LSFT,  KC_Z,     KC_X,     KC_C,     KC_V,     KC_B,     KC_____,        KC_____,  KC_N,     KC_M,     KC_COMM,  KC_DOT,   KC_SLSH,  KC_RSFT,
  L_MEDIA,  KC_____,  KC_____,  KC_OS,    KC_LALT,                                                KC_LEFT,  KC_DOWN,  KC_UP,    KC_RGHT,  KC_____,
                                                    KC_____,  KC_____,        KC_____,  KC_DEL,
                                                              KC_____,        KC_____,
                                          KC_BSPC,  KC_TAB,   L_FN,           L_FN,     KC_ENT,   KC_SPC
),


/* _FN Layer
 *
 *              ,---------------------------------------------------.            ,--------------------------------------------------.
 *              |Version  |  F1  |  F2  |  F3  |  F4  |  F5  |      |            |      |  F6  |  F7  |  F8  |  F9  |  F10 |   F11  |
 *              |---------+------+------+------+------+------+------|            |------+------+------+------+------+------+--------|
 *              |         |   !  |   @  |   {  |   }  |   |  |      |            |      |      |   7  |   8  |   9  |   *  |   F12  |
 *              |---------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |         |   #  |   $  |   (  |   )  |   `  |------|            |------|      |   4  |   5  |   6  |   +  |        |
 *              |---------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |         |   %  |   ^  |   [  |   ]  |   ~  |      |            |      |   &  |   1  |   2  |   3  |   \  |        |
 *              `---------+------+------+------+------+-------------'            `-------------+------+------+------+------+--------'
 *                |EEP_RST|      |      |      |      |                                        |   0  |      |   .  |   =  |MD_BOOT|
 *                `-----------------------------------'                                        `-----------------------------------'
 *                                                     ,-------------.        ,-------------.
 *                                                     |      |      |        |      |      |
 *                                              ,------|------|------|        |------+------+------.
 *                                              |      |      |      |        |      |      |      |
 *                                              |      |      |------|        |------|      |      |
 *                                              |      |      |      |        |      |      |      |
 *                                              `--------------------'        `--------------------'
 */

[_FN] = LAYOUT_ergodox_pretty(
  VERSION,  KC_F1,    KC_F2,    KC_F3,    KC_F4,    KC_F5,    KC_____,        KC_____,  KC_F6,    KC_F7,    KC_F8,    KC_F9,    KC_F10,   KC_F11,
  _______,  KC_EXLM,  KC_AT,    KC_LCBR,  KC_RCBR,  KC_PIPE,  KC_____,        KC_____,  KC_____,  KC_7,     KC_8,     KC_O,     KC_ASTR,  KC_F12,
  _______,  KC_HASH,  KC_DLR,   KC_LPRN,  KC_RPRN,  KC_GRV,                             KC_____,  KC_4,     KC_5,     KC_L,     KC_PLUS,  KC_____,
  _______,  KC_PERC,  KC_CIRC,  KC_LBRC,  KC_RBRC,  KC_TILD,  KC_____,        KC_____,  KC_AMPR,  KC_1,     KC_2,     KC_DOT,   KC_BSLS,  KC_____,
  EEP_RST,  KC_____,  KC_____,  KC_____,  KC_____,                                                KC_0,     KC_____,  KC_DOT,   KC_EQL,   MD_BOOT,
                                                    KC_____,  KC_____,        KC_____,  KC_____,
                                                              KC_____,        KC_____,
                                          KC_____,  KC_____,  KC_____,        KC_____,  KC_____,   KC_____
),


/* _MEDIA Layer
 *
 *              ,--------------------------------------------------.            ,--------------------------------------------------.
 *              |        |      |      |      |      |      |      |            |      |      |      |      |      |      |        |
 *              |--------+------+------+------+------+-------------|            |------+------+------+------+------+------+--------|
 *              |        |      | MsUp |      |      |      |      |            |      |      |      |      |      |      |        |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |        |MsLeft|MsDown|MsRght|      |      |------|            |------| Left | Down |  Up  | Right|      |        |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |        |      |      |      |      |      |      |            |      |      |      |      |      |      |        |
 *              `--------+------+------+------+------+-------------'            `-------------+------+------+------+------+--------'
 *                |      |      |      | Lclk | Rclk |                                        | Prev |VolDn | VolUp| Next | Mute |
 *                `----------------------------------'                                        `----------------------------------'
 *                                                     ,-------------.        ,-------------.
 *                                                     |Animat|Toggle|        |      |      |
 *                                              ,------|------|------|        |------+------+------.
 *                                              |Bright|Bright| Hue+ |        |      |      |      |
 *                                              |ness- |ness+ |------|        |------|      | Play |
 *                                              |      |      | Hue- |        |      |      |      |
 *                                              `--------------------'        `--------------------'
 */

[_MEDIA] = LAYOUT_ergodox_pretty(
  _______,  _______,  _______,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  KC_MS_U,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  KC_MS_L,  KC_MS_D,  KC_MS_R,  _______,  _______,                            KC_LEFT,  KC_DOWN,  KC_UP,    KC_RGHT,  _______,  _______,
  _______,  _______,  _______,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  _______,  KC_BTN1,  KC_BTN2,                                                KC_MPRV,  KC_VOLD,  KC_VOLU,  KC_MNXT,  KC_MUTE,
                                                    RGB_MOD,  RGB_TOG,        _______,  _______,
                                                              RGB_HUU,        _______,
                                          RGB_BRD,  RGB_BRU,  RGB_HUD,        _______,  _______,  KC_MPLY
),
};


/* Keymap 0: Basic layer
 *
 *              ,--------------------------------------------------.            ,--------------------------------------------------.
 *              |        |      |      |      |      |      |      |            |      |      |      |      |      |      |        |
 *              |--------+------+------+------+------+-------------|            |------+------+------+------+------+------+--------|
 *              |        |      |      |      |      |      |      |            |      |      |      |      |      |      |        |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |        |      |      |      |      |      |------|            |------|      |      |      |      |      |        |
 *              |--------+------+------+------+------+------|      |            |      |------+------+------+------+------+--------|
 *              |        |      |      |      |      |      |      |            |      |      |      |      |      |      |        |
 *              `--------+------+------+------+------+-------------'            `-------------+------+------+------+------+--------'
 *                |      |      |      |      |      |                                        |      |      |      |      |      |
 *                `----------------------------------'                                        `----------------------------------'
 *                                                     ,-------------.        ,-------------.
 *                                                     |      |      |        |      |       |
 *                                              ,------|------|------|        |------+-------+------.
 *                                              |      |      |      |        |      |       |      |
 *                                              |      |      |------|        |------|       |      |
 *                                              |      |      |      |        |      |       |      |
 *                                              `--------------------'        `---------------------'
 *

[BASE] = LAYOUT_ergodox_pretty(
  _______,  _______,  _______,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  _______,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  _______,  _______,  _______,  _______,                            _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  _______,  _______,  _______,  _______,  _______,        _______,  _______,  _______,  _______,  _______,  _______,  _______,
  _______,  _______,  _______,  _______,  _______,                                                _______,  _______,  _______,  _______,  _______,
                                                    _______,  _______,        _______,  _______,
                                                              _______,        _______,
                                          _______,  _______,  _______,        _______,  _______,  _______
),
 */



bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  static uint32_t key_timer;

  switch (keycode) {
      case VERSION:
        if (record->event.pressed) {
          SEND_STRING(QMK_KEYBOARD "/" QMK_KEYMAP " @ " QMK_VERSION);
        }
        return false;
      case MD_BOOT:
        if (record->event.pressed) {
            key_timer = timer_read32();
        } else {
            if (timer_elapsed32(key_timer) >= 500) {
                reset_keyboard();
            }
        }
        return false;
      default:
        return true; //Process all other keycodes normally
  }
}

// Runs just one time when the keyboard initializes.
void matrix_init_user(void) {
};

// Runs whenever there is a layer state change.
layer_state_t layer_state_set_user(layer_state_t state) {
  ergodox_board_led_off();
  ergodox_right_led_1_off();
  ergodox_right_led_2_off();
  ergodox_right_led_3_off();

  uint8_t layer = biton32(state);
  switch (layer) {
      case _DEFAULT:
        break;
      case _FN:
        ergodox_right_led_1_on();
        break;
      case _MEDIA:
        ergodox_right_led_2_on();
        break;
      case 3:
        ergodox_right_led_3_on();
        break;
      case 4:
        ergodox_right_led_1_on();
        ergodox_right_led_2_on();
        break;
      case 5:
        ergodox_right_led_1_on();
        ergodox_right_led_3_on();
        break;
      case 6:
        ergodox_right_led_2_on();
        ergodox_right_led_3_on();
        break;
      case 7:
        ergodox_right_led_1_on();
        ergodox_right_led_2_on();
        ergodox_right_led_3_on();
        break;
      default:
        break;
    }

  return state;
};
